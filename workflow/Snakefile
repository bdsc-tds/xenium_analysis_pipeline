from typing import Any
import os
import json
include: "scripts/utils/config_utils.py"
include: "scripts/utils/raw_data_utils.py"

# Ensure that only one configuration file is used.
if len(workflow.configfiles) > 1:
    raise RuntimeError(f"Error! At most one configuration file is allowed to be passed via command line options, but {len(workflow.configfiles)} are detected.")
elif len(workflow.configfiles) == 0:
    configfile: 'config/config.yml'
assert len(workflow.configfiles) == 1

process_config(
    config,
    root_path=os.path.dirname(
        os.path.normpath(
            os.path.abspath(
                workflow.configfiles[0]
            )
        )
    )
)


#######################################
#              Wildcards              #
#######################################

import config_constants as cc


"""
Explanation of wildcards:
- sample_id: The name of an sample to be processed with a format of "disease/gene_panel/donor/sample".
- segmentation_id: The name of a segmentation method to be used.
- annotation_id: The name of cell-type annotation to be used in a format "approach/reference_type/method/level/mode". E.g., "reference_based/matched_reference/rctd/Level3/single_cell".
"""

SAMPLE_ID = get_dict_value(
    config,
    cc.WILDCARDS_NAME,
    cc.WILDCARDS_SAMPLES_NAME
)
SEGMENTATION_ID = get_dict_value(
    config,
    cc.WILDCARDS_NAME,
    cc.WILDCARDS_SEGMENTATION_NAME
)
ANNOTATION_ID = get_dict_value(
    config,
    cc.WILDCARDS_NAME,
    cc.WILDCARDS_ANNOTATION_NAME
)

wildcard_constraints:
    sample_id='|'.join([re.escape(i) for i in SAMPLE_ID]),
    segmentation_id='|'.join([re.escape(i) for i in SEGMENTATION_ID])
    annotation_id='|'.join([re.escape(i) for i in ANNOTATION_ID])


########################################
#           Predefined rules           #
########################################

include: 'rules/reprocess_raw_data.smk'
include: 'rules/segmentation.smk'
include: 'rules/standard_seurat_analysis.smk'
include: 'rules/celltype_annotation.smk'


#######################################
#                Rules                #
#######################################

rule all:
    input:
        
